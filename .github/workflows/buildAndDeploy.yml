name: Deploy Carveo

on:
  push:
    branches: [ main ] 
jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Clean workspace with proper permissions
      run: |
        sudo chown -R ubuntu:ubuntu /home/ubuntu/actions-runner/_work/Carveo/Carveo/ || true
        sudo chmod -R 755 /home/ubuntu/actions-runner/_work/Carveo/Carveo/ || true
        sudo rm -rf /home/ubuntu/actions-runner/_work/Carveo/Carveo/* || true
    
    - uses: actions/checkout@v4
    - name: Set up permissions after checkout
      run: |
        sudo chown -R ubuntu:ubuntu .
        sudo chmod -R 755 .
        
    - name: Set up Docker permissions
      run: |
        sudo chown -R ubuntu:docker /var/run/docker.sock
        sudo chmod 666 /var/run/docker.sock
        
    - name: Build and deploy
      run: |
         echo "🛑 Stopping and removing old containers..."
         docker compose down || echo "No running containers to stop."

         echo "🔄 Building and starting new containers..."
         docker compose up --build -d || { echo "❌ Deployment failed! Check logs."; exit 1; }
         echo "✅ Checking if services are running..."
         sleep 10  # Give some time for services to start
         docker compose ps